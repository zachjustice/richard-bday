<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Blanksies</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <% if @client_id %>
      <meta name="discord-client-id" content="<%= @client_id %>">
    <% end %>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <% if @client_id %>
      <%= javascript_import_module_tag "discord/activity" %>
    <% end %>
  </head>
  <body class="bg-page min-h-screen <%= 'overflow-hidden' if @client_id %>">
    <% if @client_id %>
      <div id="discord-loading" class="min-h-screen flex items-center justify-center">
        <div class="card-primary p-8 text-center">
          <h1 class="text-2xl font-bold text-ink mb-4">Loading Blanksies...</h1>
          <div class="animate-spin rounded-full h-12 w-12 border-4 border-accent-blue border-t-transparent mx-auto"></div>
        </div>
      </div>

      <div id="discord-error" class="hidden min-h-screen flex items-center justify-center">
        <div class="card-primary p-8 text-center">
          <h1 class="text-2xl font-bold text-ink mb-4">Oops!</h1>
          <p id="discord-error-message" class="text-ink/70 mb-4"></p>
          <button onclick="location.reload()" class="btn-primary">Try Again</button>
        </div>
      </div>
    <% end %>

    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-easter-egg focus:bg-accent-primary focus:text-white focus:px-4 focus:py-2 focus:rounded-xl focus:font-bold">
      Skip to main content
    </a>
    <main id="main-content" tabindex="-1">
      <% if @current_room %>
        <%= turbo_stream_from "rooms:#{@current_room.id}:users" %>
        <%= turbo_stream_from "rooms:#{@current_room.id}:avatar-status" %>

        <div id="roaming-avatars"
             class="fixed inset-0 z-avatars pointer-events-none"
             data-controller="roaming-avatars"
             data-roaming-avatars-phase-value="<%= @current_room.status %>"
             data-roaming-avatars-current-user-value="<%= dom_id(@current_user, :waiting_room) if @current_user %>"
             data-turbo-permanent>
          <ul id="waiting-room" class="hidden" data-roaming-avatars-target="source">
            <% if @current_room.status == RoomStatus::Credits %>
              <% credits_accolades = @current_room.current_game&.credits_accolades || {} %>
              <% User.players.where(room: @current_room).each do |user| %>
                <%= render "rooms/partials/user_list_item", user: user, accolade: credits_accolades[user.id] || "" %>
              <% end %>
            <% else %>
              <% accolades = @current_room.current_game&.last_round_accolades || {} %>
              <% User.players.where(room: @current_room).each do |user| %>
                <% accolade = [
                  ("winner" if accolades[:winner_user_id] == user.id),
                  ("audience_favorite" if accolades[:audience_favorite_user_id] == user.id)
                ].compact.join(" ") %>
                <%= render "rooms/partials/user_list_item", user: user, accolade: accolade %>
              <% end %>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if @current_room&.current_game %>
        <%= render "shared/discord_navbar", room: @current_room %>
      <% end %>
      <div class="<%= 'pt-14' if @current_room&.current_game %>">
        <% if @current_room&.current_game&.next_game_phase_time && @current_room.status.in?([RoomStatus::Answering, RoomStatus::Voting]) %>
          <% timer_duration = @current_room.current_game.next_game_phase_time - Time.now - GameConstants::COUNTDOWN_FORGIVENESS_SECONDS %>
          <div class="fixed top-16 right-4 z-overlay">
            <div class="countdown-timer-xs">
              <%= render "shared/countdown_timer", duration: timer_duration, auto_start: true %>
            </div>
          </div>
        <% end %>
        <%= yield %>
      </div>
    </main>
  </body>
</html>
