<%
  phase_colors = {
    RoomStatus::Answering => { bg_light: "bg-accent-blue/10", bg_dark: "bg-accent-blue/30", border: "border-accent-blue" },
    RoomStatus::Voting => { bg_light: "bg-accent-indigo/10", bg_dark: "bg-accent-indigo/30", border: "border-accent-indigo" },
    RoomStatus::Results => { bg_light: "bg-accent-violet/10", bg_dark: "bg-accent-violet/30", border: "border-accent-violet" },
    RoomStatus::FinalResults => { bg_light: "bg-accent-green/10", bg_dark: "bg-accent-green/30", border: "border-accent-green" }
  }
%>

<nav class="discord-navbar" data-controller="leave-game-modal" aria-label="Game navigation">
  <%# Left â€” Branding %>
  <span class="text-xl font-bold text-ink text-shadow-brand w-20 shrink-0">Blanksies</span>

  <%# Center â€” Phase Progress %>
  <div class="flex-1 flex items-center justify-center gap-1">
    <% RoomsHelper::GAME_PHASES.each_with_index do |phase, index| %>
      <%
        is_current = phase[:status] == room.status
        current_index = RoomsHelper::GAME_PHASES.find_index { |p| p[:status] == room.status }
        is_completed = current_index && index < current_index
        # FinalResults means all 3 main phases are completed
        is_completed = true if room.status == RoomStatus::FinalResults
        item_color = phase_colors[phase[:status]]
      %>

      <% if index > 0 %>
        <span class="text-ink/20 text-xs mx-0.5">â”€â”€</span>
      <% end %>

      <div class="discord-phase-pill
                  <%= if is_current
                        "#{item_color[:bg_dark]} border-2 #{item_color[:border]}"
                      elsif is_completed
                        "bg-accent-green/15 text-ink/60"
                      else
                        "bg-ink/5 text-ink/35"
                      end %>"
           aria-label="<%= phase[:text] %>: <%= is_current ? 'current phase' : (is_completed ? 'completed' : 'upcoming') %>">
        <% if is_completed %>
          <span class="text-accent-green text-xs">âœ“</span>
        <% else %>
          <span class="text-xs"><%= phase[:icon] %></span>
        <% end %>
        <span class="hidden sm:inline text-xs"><%= phase[:text] %></span>
      </div>
    <% end %>

    <%# Separator + Final Story %>
    <span class="text-ink/15 text-xs mx-0.5">â”‚</span>
    <%
      is_final = room.status == RoomStatus::FinalResults
      final_color = phase_colors[RoomStatus::FinalResults]
    %>
    <div class="discord-phase-pill
                <%= is_final ? "#{final_color[:bg_dark]} border-2 #{final_color[:border]}" : "bg-ink/5 text-ink/35" %>"
         aria-label="Final Story: <%= is_final ? 'current phase' : 'upcoming' %>">
      <span class="text-xs">ðŸ“œ</span>
      <span class="hidden sm:inline text-xs">Final</span>
    </div>
  </div>

  <%# Right â€” Refresh + Leave Buttons %>
  <div class="flex items-center gap-1 justify-end">
    <button type="button"
            class="p-1.5 rounded-lg cursor-pointer transition-all hover:bg-ink/5 active:scale-95 text-ink/60 hover:text-ink"
            data-controller="refresh-nav"
            data-refresh-nav-room-id-value="<%= room.id %>"
            data-action="click->refresh-nav#refresh"
            aria-label="Refresh page"
            title="Refresh page">
      <svg class="w-5 h-5" data-refresh-nav-target="icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.49 9A9 9 0 0 0 5.64 5.64L4 9m16 6l-1.64 3.36A9 9 0 0 1 3.51 15"/>
      </svg>
    </button>
    <button type="button"
            class="p-1.5 rounded-lg cursor-pointer transition-all hover:bg-ink/5 active:scale-95 text-ink/60 hover:text-ink"
            data-action="click->leave-game-modal#open"
            aria-label="Leave game"
            title="Leave game">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
      </svg>
    </button>
  </div>

  <%# Leave Game Modal %>
  <div class="leave-game-modal hidden"
       data-leave-game-modal-target="modal"
       role="dialog"
       aria-labelledby="discord-leave-modal-title"
       aria-modal="true"
       aria-hidden="true">
    <div class="leave-game-backdrop" data-action="click->leave-game-modal#close"></div>
    <div class="leave-game-content">
      <div class="text-center p-8">
        <div class="text-5xl mb-4">
          <svg class="w-16 h-16 mx-auto text-ink" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
          </svg>
        </div>
        <h2 id="discord-leave-modal-title" class="text-2xl font-bold text-ink mb-3">Leaving so soon?</h2>
        <p class="text-ink/60 mb-6">You'll have to rejoin if you want to play again.</p>
        <div class="flex flex-col gap-3">
          <%= button_to session_path, method: :delete, class: "btn-primary w-full" do %>
            Leave the Game
          <% end %>
          <button type="button"
                  class="btn-secondary w-full"
                  data-action="click->leave-game-modal#close">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>
