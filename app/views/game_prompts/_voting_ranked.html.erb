<%
  max_slots = [@answers.count, @current_room.max_ranks].min
  medals = GameConstants::RANKED_MEDALS
  config = @current_room.voting_config
%>

<div data-controller="ranked-voting"
     data-ranked-voting-max-slots-value="<%= max_slots %>"
     data-ranked-voting-medals-value="<%= medals.to_json %>"
     class="<%= discord_authenticated? ? 'flex items-center max-sm:items-start justify-center bg-page' : 'min-h-screen flex items-center max-sm:items-start justify-center bg-page' %>">
  <div class="card-primary animate-slide-up <%= discord_authenticated? ? 'p-6 m-4 relative z-content' : 'p-10 m-10' %> max-sm:p-4 max-sm:mx-2 max-sm:my-4 max-w-2xl w-full flex flex-col min-h-[600px]">
    <%= render "shared/round_badge" if discord_authenticated? %>

    <div class="text-center mb-6">
      <h2 class="text-2xl max-sm:text-xl font-bold text-gray-900 leading-snug">
        <%= @game_prompt.prompt.description %>
      </h2>
      <p class="text-ink/60 mt-2 text-sm" data-ranked-voting-target="hintText">Tap and drag the <b>⋮⋮</b> to rank your top <%= max_slots %></p>
      <p class="sr-only">
        Keyboard users: Press Enter or Space to select an answer, then use arrow keys to navigate to a rank slot and press Enter to place it. Press Escape to cancel selection. Press Delete or Backspace on a filled slot to remove an answer.
      </p>
    </div>

    <%= form_with url: "/vote", method: :post,
                  data: { ranked_voting_target: "form" },
                  class: "flex flex-col gap-6 flex-1" do |form| %>
      <%= form.hidden_field :game_prompt_id, value: @game_prompt.id %>

      <%# Ranking slots %>
      <div class="flex flex-col gap-3"
           data-ranked-voting-target="slots"
           role="group"
           aria-label="Ranking slots - place your top <%= max_slots %> answers here">
        <% max_slots.times do |i| %>
          <div class="ranking-slot"
               data-rank="<%= i + 1 %>"
               data-ranked-voting-target="slot">
            <span class="ranking-medal"><%= medals[i] %></span>
            <span class="ranking-points"><%= config.dig("points", (i + 1).to_s) %> pts</span>
            <div class="ranking-placeholder" data-ranked-voting-target="placeholder">
              Drop answer here
            </div>
            <%= hidden_field_tag "rankings[#{i + 1}]", "", data: { ranked_voting_target: "input" } %>
          </div>
        <% end %>
      </div>

      <%# Available answers %>
      <div class="flex flex-col gap-3 p-1 ranking-answers-scrollable scroll-fade-indicators overflow-y-scroll shrink-0"
           style="max-height: 250px;"
           data-ranked-voting-target="answersContainer"
           role="listbox"
           aria-label="Available answers to rank">
        <% @answers.each do |answer| %>
          <div class="ranking-answer"
               draggable="false"
               data-answer-id="<%= answer.id %>"
               data-ranked-voting-target="answer">
            <span class="ranking-handle">⋮⋮</span>
            <p class="answer-text"><%= answer.text %></p>
          </div>
        <% end %>
      </div>

      <%= form.submit "Submit Rankings",
                      class: "btn-primary mt-4",
                      data: { ranked_voting_target: "submit" },
                      disabled: true %>
    <% end %>
  </div>
</div>
