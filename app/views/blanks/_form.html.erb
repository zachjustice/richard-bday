<%# app/views/blanks/_form.html.erb %>
<% edit_mode = blank.persisted? %>

<%= form_with model: blank,
    id: "blank-modal-form",
    url: edit_mode ? story_blank_path(story, blank) : story_blanks_path(story),
    method: edit_mode ? :patch : :post,
    data: {
      controller: "blank-form",
      blank_form_story_id_value: story.id,
      blank_form_blank_id_value: blank.id,
      blank_form_edit_mode_value: edit_mode,
      blank_form_existing_prompt_ids_value: blank.prompts.pluck(:id).to_json
    } do |form| %>

  <%= render "blanks/form_errors", blank: blank %>

  <!-- Tags Input -->
  <div class="flex flex-col gap-2">
    <%= form.label :tags, "Tags (comma-separated)", class: "font-semibold text-ink" %>
    <%= form.text_field :tags,
        placeholder: "noun,animal,funny",
        class: "story-form-input",
        data: {
          action: "input->blank-form#filterPrompts",
          blank_form_target: "tagsInput"
        } %>
    <p class="text-sm text-ink/60 italic m-0">Tags help match prompts. Use commas to separate.</p>
  </div>

  <!-- Existing Prompts Selection -->
  <div class="mt-6 pt-6 border-t border-ink/20" data-blank-form-target="promptsSection">
    <h4 class="m-0 mb-3 text-base font-semibold text-ink flex items-center gap-2">
      Select Existing Prompts
      <span class="text-sm font-normal text-ink/60" data-blank-form-target="promptCount">(0 matching)</span>
    </h4>

    <div class="prompts-checklist" data-blank-form-target="promptsList">
      <p class="text-ink/60 text-sm italic m-1">Enter tags above to see matching prompts</p>
    </div>
  </div>

  <!-- New Prompts Creation -->
  <div class="mt-6 pt-6 border-t border-ink/20">
    <h4 class="m-0 mb-3 text-base font-semibold text-ink">Or Create New Prompts</h4>
    <p class="text-sm text-ink/60 italic m-0 mb-3">New prompts will inherit the blank's tags</p>

    <div class="flex flex-col gap-3 mb-3" data-blank-form-target="newPromptsList">
      <!-- Dynamic prompt fields added here -->
    </div>

    <button type="button"
            class="btn-secondary btn-sm"
            data-action="click->blank-form#addNewPromptField">
      + Add New Prompt
    </button>
  </div>

  <!-- Validation Message -->
  <div class="hidden bg-red-500/10 border-2 border-error-light rounded-lg p-3 mt-4 text-sm text-error font-medium" data-blank-form-target="validationHint">
    You must select at least one existing prompt OR create a new one.
  </div>

  <div class="flex gap-4 pt-4">
    <%= form.submit edit_mode ? "Update Blank" : "Create Blank",
        class: "btn-primary btn-sm",
        data: { controller: "loading-button", blank_form_target: "submitButton" } %>
  </div>
<% end %>
