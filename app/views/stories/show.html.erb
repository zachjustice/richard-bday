<%# app/views/stories/show.html.erb %>
<div class="bg-page editor-page-viewport">
  <div class="max-w-[1400px] flex flex-col flex-1 p-8 md:p-4 mx-auto w-full min-h-0">
    <div class="flex justify-between items-start mb-8 pb-6 border-b-3 border-ink flex-wrap gap-4">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-3 flex-wrap">
          <h1 class="text-3xl font-bold text-ink m-0"><%= @story.title %></h1>
          <% unless @story.published %>
            <span class="px-3 py-1 rounded-lg text-sm font-bold bg-ink/10 text-ink/60">Draft</span>
          <% end %>
        </div>
        <% if @story.author.present? || @story.genres.any? %>
          <div class="flex items-center gap-3 flex-wrap">
            <% if @story.author.present? %>
              <span class="text-ink/60 text-sm">by <%= @story.author.username %></span>
            <% end %>
            <% if @story.genres.any? %>
              <div class="flex flex-wrap gap-1.5">
                <% @story.genres.each do |genre| %>
                  <span class="tag text-xs"><%= genre.name %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="flex gap-4">
        <% if @story.owned_by?(current_editor) %>
          <%= link_to "Edit Story", edit_story_path(@story), class: "btn-primary" %>
        <% end %>
      </div>
    </div>

    <% unless @validation[:valid] %>
      <div class="bg-red-500/10 border-2 border-error-light rounded-xl p-6 mb-8">
        <h3 class="text-error m-0 mb-4 font-bold flex items-center gap-2">
          <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
          Story Validation Issues:
        </h3>
        <% if @validation[:missing].any? %>
          <p class="text-error m-1 font-mono text-sm">Missing blanks in text: <%= @validation[:missing].map { |id| "{#{id}}" }.join(", ") %></p>
        <% end %>
        <% if @validation[:unused].any? %>
          <p class="text-error m-1 font-mono text-sm">Undefined blanks in text: <%= @validation[:unused].map { |id| "{#{id}}" }.join(", ") %></p>
        <% end %>
      </div>
    <% end %>

    <div class="grid grid-cols-[2fr_1fr] gap-8 max-lg:grid-cols-1 flex-1 min-h-0">
      <%# Left column: Story text %>
      <div class="bg-white p-8 rounded-xl border-3 border-ink shadow-strong overflow-y-auto min-h-48">
        <h2 class="text-xl font-bold text-ink m-0 mb-4">Story Text:</h2>
        <div class="font-serif text-lg leading-relaxed text-ink">
          <%= simple_format(highlight_blanks_in_text(@story.text)) %>
        </div>
      </div>

      <%# Right column: Blanks panel %>
      <div class="bg-white p-6 rounded-xl border-3 border-ink shadow-strong flex flex-col gap-4 overflow-y-auto min-h-48">
        <h2 class="text-xl font-bold text-ink m-0">Blanks (<%= @story.blanks.count %>)</h2>

        <% @ordered_blanks.each do |blank| %>
          <div class="p-4 rounded-xl border-3 border-ink bg-accent-tertiary/10">
            <div class="flex items-center gap-2 mb-2">
              <span class="blank-id <%= blank_id_to_bg_color(blank.id) %>">{<%= blank.id %>}</span>
            </div>

            <div class="flex flex-wrap gap-1.5 mb-3">
              <% blank.tags_array.each do |tag| %>
                <span class="tag text-xs"><%= tag %></span>
              <% end %>
            </div>

            <% prompts = blank.matching_prompts.to_a %>
            <% if prompts.any? %>
              <div class="text-sm text-ink/80" data-controller="expand-list">
                <ol class="list-decimal list-inside m-0 p-0 space-y-0.5">
                  <% prompts.first(5).each do |prompt| %>
                    <li class="text-sm text-ink/70"><%= prompt.description %></li>
                  <% end %>
                </ol>
                <% if prompts.size > 5 %>
                  <div class="hidden" data-expand-list-target="overflow">
                    <ol class="list-decimal list-inside m-0 p-0 space-y-0.5" start="6">
                      <% prompts.drop(5).each do |prompt| %>
                        <li class="text-sm text-ink/70"><%= prompt.description %></li>
                      <% end %>
                    </ol>
                  </div>
                  <button type="button"
                        class="text-xs font-semibold text-accent-secondary mt-1 cursor-pointer underline"
                        data-action="click->expand-list#toggle"
                    data-expand-list-target="toggleButton">
                    see <%= prompts.size - 5 %> more...
                  </button>
                <% end %>
              </div>
            <% else %>
              <p class="text-xs text-ink/50 italic m-0">No matching prompts</p>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
