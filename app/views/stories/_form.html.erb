<%# app/views/stories/_form.html.erb %>
<%= form_with model: story, class: "flex flex-col gap-6" do |form| %>
  <% if story.errors.any? %>
    <div class="bg-red-500/10 border-2 border-error-light rounded-lg p-4">
      <h4 class="text-error m-0 mb-2 text-base font-semibold">Please fix the following errors:</h4>
      <ul class="m-0 pl-4 text-error text-sm">
        <% story.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="flex flex-col gap-2">
    <%= form.label :title, "Story Title", class: "font-semibold text-ink" %>
    <%= form.text_field :title,
        placeholder: "...",
        required: true,
        class: "story-form-input",
        data: {
          story_editor_target: "title",
          action: "input->story-editor#saveDraft"
        } %>
  </div>

  <% if story.persisted? %>
    <div class="flex flex-col gap-2">
      <%= form.label :text, "Story Text (with blanks)", class: "font-semibold text-ink" %>
      <%= form.text_area :text,
          rows: 12,
          placeholder: "Write your story here. Use {1}, {2}, etc. for blanks.",
          required: true,
          class: "story-form-textarea",
          data: {
            story_editor_target: "text",
            action: "input->story-editor#highlightBlanks input->story-editor#saveDraft"
          } %>

      <div data-story-editor-target="status"
           class="flex items-center gap-2 text-sm h-6 transition-opacity duration-300 opacity-0"
           aria-live="polite">
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <%= form.label :original_text, "Original Text (for reference)", class: "font-semibold text-ink" %>
      <%= form.text_area :original_text,
          rows: 6,
          placeholder: "Original unmodified version",
          required: true,
          class: "story-form-textarea",
          data: {
            story_editor_target: "originalText",
            action: "input->story-editor#saveDraft"
          } %>
    </div>

    <% if defined?(@genres) && @genres.present? %>
      <div class="flex flex-col gap-2">
        <%= render "shared/multi_select",
            form: form,
            field_name: :genre_ids,
            options: @genres,
            selected: story.genres,
            placeholder: "Add genres...",
            label: "Genres" %>
      </div>
    <% end %>

    <div class="flex flex-row items-center gap-3">
      <%= form.checkbox :published,
          class: "w-5 h-5 cursor-pointer accent-accent-primary" %>
      <%= form.label :published, "Publish (visible to all players)", class: "font-semibold text-ink" %>
    </div>
  <% end %>

  <div class="flex gap-4 pt-4">
    <%= form.submit story.persisted? ? "Update Story" : "Create Story",
        class: "btn-primary",
        data: { controller: "loading-button" } %>
    <%= link_to "Cancel",
        story.persisted? ? story_path(story) : stories_path,
        class: "btn-secondary" %>
  </div>
<% end %>
