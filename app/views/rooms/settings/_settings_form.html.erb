<% form_saved = local_assigns.fetch(:form_saved, false) %>
<%= form_with model: room,
              url: update_room_settings_path(room),
              method: :patch,
              data: {
                turbo_frame: "settings-form",
                action: "turbo:submit-start->settings-modal#submitting turbo:submit-end->settings-modal#submitted"
              },
              class: "p-8 flex flex-col gap-6" do |form| %>
  <% if room.errors.any? %>
    <div class="p-4 rounded-xl border-3 border-accent-primary bg-accent-primary/10 mb-4">
      <% room.errors.full_messages.each do |message| %>
        <p class="flex items-center gap-2 text-accent-primary text-sm font-medium m-0">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="10" cy="10" r="8"/>
            <path d="M10 6v5M10 14v.01"/>
          </svg>
          <%= message %>
        </p>
      <% end %>
    </div>
  <% end %>

  <div class="flex flex-col gap-2" data-controller="time-input">
    <label class="label">Time to Answer</label>
    <%= form.hidden_field :time_to_answer_seconds, data: { time_input_target: "hiddenField" } %>
    <div class="flex gap-3 items-center">
      <input type="number" min="0" max="20" class="form-input flex-1"
             data-time-input-target="minutes"
             data-action="input->time-input#updateTotal">
      <span class="font-medium body">min</span>
      <input type="number" min="0" max="59" class="form-input flex-1"
             data-time-input-target="seconds"
             data-action="input->time-input#updateTotal">
      <span class="font-medium body">sec</span>
    </div>
    <span class="text-sm body italic">Between 30 seconds and 20 minutes</span>
  </div>

  <div class="flex flex-col gap-2" data-controller="time-input">
    <label class="label">Time to Vote</label>
    <%= form.hidden_field :time_to_vote_seconds, data: { time_input_target: "hiddenField" } %>
    <div class="flex gap-3 items-center">
      <input type="number" min="0" max="20" class="form-input flex-1"
             data-time-input-target="minutes"
             data-action="input->time-input#updateTotal">
      <span class="font-medium body">min</span>
      <input type="number" min="0" max="59" class="form-input flex-1"
             data-time-input-target="seconds"
             data-action="input->time-input#updateTotal">
      <span class="font-medium body">sec</span>
    </div>
    <span class="text-sm body italic">Between 30 seconds and 20 minutes</span>
  </div>

  <%# Display Preferences - stored in localStorage, not submitted with form %>
  <div class="flex flex-col gap-2 pt-4 border-t border-ink/10">
    <label class="label">Display Preferences</label>
    <label class="flex items-center gap-3 cursor-pointer">
      <input type="checkbox"
             class="w-5 h-5 rounded border-2 border-ink/30 cursor-pointer accent-accent-secondary"
             data-tutorial-hints-target="dismissCheckbox"
             data-action="change->tutorial-hints#updatePreference">
      <span class="text-sm body">Don't show tutorial hints</span>
    </label>
    <span class="text-sm body italic text-ink/60">Hides the popups that point to settings and music buttons</span>
  </div>

  <%# AI Features %>
  <div class="flex flex-col gap-2 pt-4 border-t border-ink/10">
    <label class="label">AI Features</label>
    <label class="flex items-center gap-3 cursor-pointer">
      <%= form.check_box :smooth_answers,
          class: "w-5 h-5 rounded border-2 border-ink/30 cursor-pointer accent-accent-secondary" %>
      <span class="text-sm body">Smooth answers with AI</span>
    </label>
    <span class="text-sm body italic text-ink/60">
      Adapts winning answers to fit grammatically into sentences
    </span>
  </div>

  <div class="flex gap-4 mt-4 flex-col sm:flex-row">
    <%= form.submit "Save Settings",
        class: "btn-primary flex-1",
        data: { settings_modal_target: "submitButton" } %>
    <button type="button"
            class="btn-secondary flex-1"
            data-action="click->settings-modal#close">
      Cancel
    </button>
  </div>

  <% if form_saved %>
    <div class="animate-slide-up">
      <p class="text-success font-medium animate-bounce-custom">Settings updated successfully</p>
    </div>
  <% end %>
<% end %>
