#!/usr/bin/env bash
set -euo pipefail

# Restore a SQLite3 backup to a given environment.
# For production restores, prompts for confirmation before overwriting.
#
# Usage: bin/restore-db <environment> <backup-file>
#   environment: development | production
#   backup-file: path to a .sqlite3 backup file

SERVER="174.138.60.116"

usage() {
  echo "Usage: bin/restore-db <environment> <backup-file>"
  echo "  environment: development | production"
  echo "  backup-file: path to a .sqlite3 backup file"
  exit 1
}

if [ $# -ne 2 ]; then
  usage
fi

ENVIRONMENT="$1"
BACKUP_FILE="$2"

if [[ "${ENVIRONMENT}" != "development" && "${ENVIRONMENT}" != "production" ]]; then
  echo "ERROR: environment must be 'development' or 'production'"
  usage
fi

if [ ! -f "${BACKUP_FILE}" ]; then
  echo "ERROR: backup file not found: ${BACKUP_FILE}"
  exit 1
fi

echo "==> Validating backup file..."
INTEGRITY=$(sqlite3 "${BACKUP_FILE}" "PRAGMA integrity_check;" 2>&1)
if [ "${INTEGRITY}" != "ok" ]; then
  echo "ERROR: backup file failed integrity check:"
  echo "  ${INTEGRITY}"
  exit 1
fi
echo "    Integrity check passed"

if [ "${ENVIRONMENT}" = "development" ]; then
  echo "==> Restoring to development database..."
  cp "${BACKUP_FILE}" storage/development.sqlite3
  echo ""
  echo "==> Restore complete!"
  echo "    Restored ${BACKUP_FILE} -> storage/development.sqlite3"
  echo "    Restart your local Rails server to pick up the new database."
  exit 0
fi

# Production restore
echo ""
echo "WARNING: You are about to overwrite the PRODUCTION database."
echo "  Server: ${SERVER}"
echo "  Backup: ${BACKUP_FILE}"
echo ""
read -p "Type 'yes' to continue: " CONFIRM
if [ "${CONFIRM}" != "yes" ]; then
  echo "Aborted."
  exit 1
fi

BACKUP_FILENAME=$(basename "${BACKUP_FILE}")

echo "==> Uploading backup to server..."
scp "${BACKUP_FILE}" "root@${SERVER}:/tmp/${BACKUP_FILENAME}"

echo "==> Restoring database on remote server..."
ssh root@${SERVER} bash -s "${BACKUP_FILENAME}" <<'REMOTE_SCRIPT'
  set -euo pipefail
  BACKUP_FILENAME="$1"

  CONTAINER_ID=$(docker ps --filter "name=richard_bday-web" --format "{{.ID}}" | head -1)
  if [ -z "${CONTAINER_ID}" ]; then
    echo "ERROR: No running richard_bday-web container found." >&2
    exit 1
  fi
  echo "    Found container: ${CONTAINER_ID}"

  docker cp "/tmp/${BACKUP_FILENAME}" "${CONTAINER_ID}:/tmp/${BACKUP_FILENAME}"
  echo "    Copied backup into container"

  docker exec "${CONTAINER_ID}" sqlite3 /rails/storage/production.sqlite3 ".restore /tmp/${BACKUP_FILENAME}"
  echo "    Database restored"

  docker exec "${CONTAINER_ID}" rm "/tmp/${BACKUP_FILENAME}"
  rm "/tmp/${BACKUP_FILENAME}"
REMOTE_SCRIPT

echo ""
echo "==> Restore complete!"
echo "    Restored ${BACKUP_FILE} -> production.sqlite3 on ${SERVER}"
echo ""
echo "    REMINDER: Restart the app to pick up the new database:"
echo "      bin/kamal app boot"
