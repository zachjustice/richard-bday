#!/usr/bin/env bash
set -euo pipefail

# Backup a SQLite3 database for the given environment.
# Uses sqlite3's .backup command for a consistent, non-corrupting snapshot.
#
# Usage: bin/backup-db <environment>
#   environment: development | production

SERVER="174.138.60.116"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOCAL_BACKUP_DIR="backups"

usage() {
  echo "Usage: bin/backup-db <environment>"
  echo "  environment: development | production"
  exit 1
}

if [ $# -ne 1 ]; then
  usage
fi

ENVIRONMENT="$1"

if [[ "${ENVIRONMENT}" != "development" && "${ENVIRONMENT}" != "production" ]]; then
  echo "ERROR: environment must be 'development' or 'production'"
  usage
fi

BACKUP_FILENAME="${ENVIRONMENT}_backup_${TIMESTAMP}.sqlite3"
mkdir -p "${LOCAL_BACKUP_DIR}"

if [ "${ENVIRONMENT}" = "development" ]; then
  DB_PATH="storage/development.sqlite3"

  if [ ! -f "${DB_PATH}" ]; then
    echo "ERROR: development database not found: ${DB_PATH}"
    exit 1
  fi

  echo "==> Backing up development database..."
  sqlite3 "${DB_PATH}" ".backup ${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}"

  FILESIZE=$(ls -lh "${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}" | awk '{print $5}')
  echo ""
  echo "==> Backup complete!"
  echo "    File: ${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}"
  echo "    Size: ${FILESIZE}"
  exit 0
fi

# Production backup
echo "==> Creating backup on remote server..."

ssh root@${SERVER} bash -s "${BACKUP_FILENAME}" <<'REMOTE_SCRIPT'
  set -euo pipefail
  BACKUP_FILENAME="$1"

  CONTAINER_ID=$(docker ps --filter "name=richard_bday-web" --format "{{.ID}}" | head -1)
  if [ -z "${CONTAINER_ID}" ]; then
    echo "ERROR: No running richard_bday-web container found." >&2
    exit 1
  fi
  echo "    Found container: ${CONTAINER_ID}"

  docker exec "${CONTAINER_ID}" sqlite3 /rails/storage/production.sqlite3 ".backup /tmp/${BACKUP_FILENAME}"
  echo "    Backup created inside container"

  docker cp "${CONTAINER_ID}:/tmp/${BACKUP_FILENAME}" "/tmp/${BACKUP_FILENAME}"
  echo "    Copied to host /tmp/${BACKUP_FILENAME}"

  docker exec "${CONTAINER_ID}" rm "/tmp/${BACKUP_FILENAME}"
REMOTE_SCRIPT

echo "==> Downloading backup to local machine..."
scp "root@${SERVER}:/tmp/${BACKUP_FILENAME}" "${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}"

echo "==> Cleaning up remote temp file..."
ssh root@${SERVER} "rm /tmp/${BACKUP_FILENAME}"

FILESIZE=$(ls -lh "${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}" | awk '{print $5}')
echo ""
echo "==> Backup complete!"
echo "    File: ${LOCAL_BACKUP_DIR}/${BACKUP_FILENAME}"
echo "    Size: ${FILESIZE}"
